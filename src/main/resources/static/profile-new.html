<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Profile â€¢ Security AOP Demo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="card shadow p-4 mx-auto" style="max-width:520px;">
      <h3 class="text-center mb-3">ðŸ‘¤ My Profile</h3>
      <div id="msg"></div>

      <div class="mb-3">
        <label>Email</label>
        <input id="email" class="form-control" readonly />
      </div>
      <div class="mb-3">
        <label>Role</label>
        <input id="role" class="form-control" readonly />
      </div>
      <div class="mb-3">
        <label>Name</label>
        <input id="name" class="form-control" placeholder="Enter your name"/>
      </div>

      <button id="update" class="btn btn-primary w-100">Update Profile</button>
      <button id="logout" class="btn btn-outline-secondary w-100 mt-2">Logout</button>
    </div>
  </div>

  <script>
    const msg = document.getElementById('msg');
    const token = localStorage.getItem('token');

    if (!token) {
      msg.innerHTML = `<div class='alert alert-danger'>Please login first.</div>`;
      setTimeout(() => location.href = '/login-new.html', 1000);
    }

    async function loadProfile() {
      try {
        const res = await fetch('/auth/me', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!res.ok) throw new Error('Session expired');
        const user = await res.json();
        email.value = user.email || '';
        role.value = user.role || '';
      } catch {
        msg.innerHTML = `<div class='alert alert-danger'>Session expired. <a href='/login-new.html'>Login again</a></div>`;
      }
    }

    update.addEventListener('click', async () => {
      const newName = name.value.trim();
      if (!newName) return alert('Enter a name');
      const res = await fetch('/auth/updateProfile', {
        method: 'POST',
        headers: { 
          'Content-Type':'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ name: newName })
      });
      const text = await res.text();
      msg.innerHTML = res.ok
        ? `<div class='alert alert-success'>${text}</div>`
        : `<div class='alert alert-danger'>${text}</div>`;
    });

    logout.addEventListener('click', () => {
      localStorage.clear();
      location.href = '/login-new.html';
    });

    window.addEventListener('load', loadProfile);
  </script>
</body>
</html>
